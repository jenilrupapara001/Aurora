<section class="bundle-builder section" data-bundle-builder>
  <div class="container">
    <h2 class="bundle-builder__heading">{{ section.settings.heading }}</h2>
    <p class="bundle-builder__subheading">{{ section.settings.subheading }}</p>

    <div class="bundle-grid">
      {%- for block in section.blocks -%}
        <div class="bundle-item" {{ block.shopify_attributes }}>
          {%- assign bundle_product = all_products[block.settings.product] -%}
          
          {%- if bundle_product != blank -%}
            <div class="bundle-item__image">
              {%- if bundle_product.featured_image -%}
                <img
                  src="{{ bundle_product.featured_image | image_url: width: 400 }}"
                  alt="{{ bundle_product.title | escape }}"
                  loading="lazy"
                >
              {%- endif -%}
            </div>

            <div class="bundle-item__content">
              <h3 class="bundle-item__title">{{ bundle_product.title }}</h3>
              <p class="bundle-item__price">{{ bundle_product.price | money }}</p>
              
              <label class="bundle-item__checkbox">
                <input
                  type="checkbox"
                  data-bundle-item
                  data-product-id="{{ bundle_product.id }}"
                  data-product-title="{{ bundle_product.title | escape }}"
                  data-product-price="{{ bundle_product.price }}"
                  data-variant-id="{{ bundle_product.selected_or_first_available_variant.id }}"
                  checked
                >
                <span>{{ 'sections.bundle.include' | t }}</span>
              </label>
            </div>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>

    <div class="bundle-summary">
      <div class="bundle-summary__details">
        <p class="bundle-summary__count">
          <span data-bundle-count>{{ section.blocks.size }}</span> {{ 'sections.bundle.items_selected' | t }}
        </p>
        <p class="bundle-summary__total">
          {{ 'sections.bundle.total' | t }}: <strong data-bundle-total>$0.00</strong>
        </p>
        {%- if section.settings.show_savings -%}
          <p class="bundle-summary__savings" data-bundle-savings></p>
        {%- endif -%}
      </div>
      
      <button type="button" class="button button--primary bundle-summary__btn" data-bundle-add-all>
        {{ section.settings.button_text }}
      </button>
    </div>
  </div>
</section>

<style>
  .bundle-builder__heading {
    text-align: center;
    font-size: 2.5rem;
    margin-bottom: 1rem;
  }

  .bundle-builder__subheading {
    text-align: center;
    color: var(--color-text-secondary);
    margin-bottom: 3rem;
  }

  .bundle-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .bundle-item {
    border: 2px solid var(--color-border);
    padding: 1.5rem;
    text-align: center;
    transition: border-color 0.2s ease;
  }

  .bundle-item.selected {
    border-color: var(--color-primary);
  }

  .bundle-item__image {
    aspect-ratio: 1;
    margin-bottom: 1rem;
    overflow: hidden;
  }

  .bundle-item__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .bundle-item__title {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
  }

  .bundle-item__price {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .bundle-item__checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .bundle-item__checkbox input {
    width: 20px;
    height: 20px;
  }

  .bundle-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
    background-color: var(--color-neutral-medium);
    border: 2px solid var(--color-border);
  }

  .bundle-summary__count,
  .bundle-summary__total {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
  }

  .bundle-summary__savings {
    color: var(--color-success);
    font-weight: 600;
  }

  .bundle-summary__btn {
    min-width: 200px;
  }

  @media (max-width: 767px) {
    .bundle-summary {
      flex-direction: column;
      text-align: center;
    }

    .bundle-summary__btn {
      width: 100%;
    }
  }
</style>

<script>
  class BundleBuilder {
    constructor() {
      this.items = document.querySelectorAll('[data-bundle-item]');
      this.countEl = document.querySelector('[data-bundle-count]');
      this.totalEl = document.querySelector('[data-bundle-total]');
      this.savingsEl = document.querySelector('[data-bundle-savings]');
      this.addAllBtn = document.querySelector('[data-bundle-add-all]');
      
      this.init();
    }

    init() {
      this.items.forEach(item => {
        item.addEventListener('change', () => this.updateSummary());
        item.closest('.bundle-item').classList.add('selected');
      });

      if (this.addAllBtn) {
        this.addAllBtn.addEventListener('click', () => this.addAllToCart());
      }

      this.updateSummary();
    }

    updateSummary() {
      let count = 0;
      let total = 0;

      this.items.forEach(item => {
        const parent = item.closest('.bundle-item');
        if (item.checked) {
          count++;
          total += parseFloat(item.dataset.productPrice);
          parent.classList.add('selected');
        } else {
          parent.classList.remove('selected');
        }
      });

      if (this.countEl) this.countEl.textContent = count;
      if (this.totalEl) this.totalEl.textContent = Shopify.formatMoney(total, theme.moneyFormat || '${{amount}}');
    }

    async addAllToCart() {
      const selectedItems = Array.from(this.items)
        .filter(item => item.checked)
        .map(item => ({
          id: item.dataset.variantId,
          quantity: 1
        }));

      if (selectedItems.length === 0) return;

      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ items: selectedItems })
        });

        if (response.ok) {
          window.location.href = '/cart';
        }
      } catch (error) {
        console.error('Error adding bundle to cart:', error);
      }
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new BundleBuilder());
  } else {
    new BundleBuilder();
  }
</script>

{% schema %}
{
  "name": "Bundle Builder",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Complete the Look"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Select items to create your perfect bundle"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Add Bundle to Cart"
    },
    {
      "type": "checkbox",
      "id": "show_savings",
      "label": "Show savings",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Bundle Builder",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}
